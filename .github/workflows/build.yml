# .github/workflows/build.yml

name: Build Patched Augment Code Extension

on:
  # å…è®¸ä½ æ‰‹åŠ¨åœ¨ GitHub Actions é¡µé¢ç‚¹å‡» "Run workflow" æŒ‰é’®æ¥è§¦å‘
  workflow_dispatch:

  # æ¯å¤©æ—©ä¸Š 8 ç‚¹ (UTC) è‡ªåŠ¨è¿è¡Œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
  schedule:
    - cron: '0 8 * * *'

  # å½“ä½ çš„è¡¥ä¸è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶æœ¬èº«è¢«æ›´æ–°æ—¶ï¼Œä¹Ÿè‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'v2.5-precise-interceptor.js'
      - '.github/workflows/**'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # æˆäºˆå·¥ä½œæµå‘ä»“åº“åˆ›å»º Release çš„æƒé™

    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä½ çš„ä»£ç 
      # ç›®çš„æ˜¯è·å–ä»“åº“ä¸­çš„å»é£æ§è„šæœ¬ v2.5-precise-interceptor.js
      - name: Checkout repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: ä¸‹è½½æœ€æ–°çš„ Augment Code VSIX æ’ä»¶
      # å·²æ ¹æ®ä½ çš„è¦æ±‚æ›´æ–° PUBLISHER å’Œ EXTENSION_NAME
      - name: Download Latest VSIX
        run: |
          PUBLISHER="augment"
          EXTENSION_NAME="vscode-augment"
          VSIX_URL="https://marketplace.visualstudio.com/_apis/public/gallery/publishers/${PUBLISHER}/vsextensions/${EXTENSION_NAME}/latest/vspackage"
          # ä½¿ç”¨ --compressed æ ‡å¿—è®© curl è‡ªåŠ¨å¤„ç†è§£å‹ç¼©
          curl -L --compressed -o original.vsix "${VSIX_URL}"
          echo "VSIX downloaded and decompressed successfully."
          # å¢åŠ éªŒè¯æ­¥éª¤ï¼Œç¡®è®¤æ–‡ä»¶ç°åœ¨æ˜¯ Zip æ ¼å¼
          echo "Verifying downloaded file type:"
          file original.vsix

      # æ­¥éª¤ 3: è§£åŒ…å¹¶åº”ç”¨è¡¥ä¸
      - name: Unpack and Patch VSIX
        run: |
          # è§£å‹ VSIX åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•
          unzip original.vsix -d unpacked_ext
          
          # æ ¸å¿ƒè¡¥ä¸æ­¥éª¤ï¼šå°†ä½ çš„è„šæœ¬å†…å®¹æ·»åŠ åˆ°åŸå§‹ extension.js çš„å¼€å¤´
          # 1. å°†åŸå§‹æ–‡ä»¶é‡å‘½åä¸ºå¤‡ä»½
          mv unpacked_ext/extension/out/extension.js unpacked_ext/extension/out/extension.original.js
          # 2. ä½¿ç”¨ cat å‘½ä»¤å°†ä½ çš„è„šæœ¬å’ŒåŸå§‹è„šæœ¬æ‹¼æ¥æˆæ–°çš„ extension.js
          cat v2.5-precise-interceptor.js unpacked_ext/extension/out/extension.original.js > unpacked_ext/extension/out/extension.js
          
          echo "Patch applied successfully."

      # æ­¥éª¤ 4: ä»æ’ä»¶çš„ package.json ä¸­è·å–ç‰ˆæœ¬å·
      # å°†ç‰ˆæœ¬å·è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
      - name: Get extension version
        id: get_version
        run: |
          VERSION=$(jq -r .version unpacked_ext/extension/package.json)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Discovered extension version: ${VERSION}"

      # æ­¥éª¤ 5: æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å·²å­˜åœ¨
      # å¦‚æœå·²å­˜åœ¨ç›¸åŒç‰ˆæœ¬çš„ releaseï¼Œåˆ™è·³è¿‡åç»­æ„å»ºæ­¥éª¤
      - name: Check if version already exists
        id: version_check
        run: |
          TAG_NAME="v${{ env.VERSION }}-patched"
          if git tag -l | grep -q "^${TAG_NAME}$"; then
            echo "Tag ${TAG_NAME} already exists, skipping build"
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
            echo "skip_build=true" >> $GITHUB_OUTPUT
          else
            echo "New version detected: ${{ env.VERSION }}"
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
            echo "skip_build=false" >> $GITHUB_OUTPUT
          fi

      # æ­¥éª¤ 5.1: æ˜¾ç¤ºè·³è¿‡æ„å»ºçš„ä¿¡æ¯ï¼ˆä»…åœ¨è·³è¿‡æ—¶æ‰§è¡Œï¼‰
      - name: Skip build notification
        if: steps.version_check.outputs.skip_build == 'true'
        run: |
          echo "âœ… Version ${{ env.VERSION }} already exists as release v${{ env.VERSION }}-patched"
          echo "â­ï¸  Skipping build process to save time and resources"
          echo "ğŸ”„ If you want to rebuild, delete the existing tag and release first"

      # æ­¥éª¤ 6: è®¾ç½® Node.js ç¯å¢ƒï¼ˆä»…åœ¨éœ€è¦æ„å»ºæ—¶æ‰§è¡Œï¼‰
      # æ‰“åŒ… VS Code æ’ä»¶éœ€è¦ Node.js å’Œ npm
      - name: Setup Node.js
        if: steps.version_check.outputs.skip_build == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # æ­¥éª¤ 7: å®‰è£…å¿…è¦çš„å·¥å…·ï¼ˆä»…åœ¨éœ€è¦æ„å»ºæ—¶æ‰§è¡Œï¼‰
      # vsce: å¾®è½¯å®˜æ–¹çš„ VS Code æ’ä»¶æ‰“åŒ…å·¥å…·
      - name: Install dependencies
        if: steps.version_check.outputs.skip_build == 'false'
        run: |
          npm install -g @vscode/vsce

      # æ­¥éª¤ 8: å®‰è£…æ’ä»¶ä¾èµ–å¹¶åˆ›å»º .vscodeignoreï¼ˆä»…åœ¨éœ€è¦æ„å»ºæ—¶æ‰§è¡Œï¼‰
      - name: Install extension dependencies
        if: steps.version_check.outputs.skip_build == 'false'
        working-directory: ./unpacked_ext/extension
        run: |
          npm install
          # åˆ›å»º .vscodeignore æ–‡ä»¶ï¼Œç¡®ä¿ node_modules ä¸ä¼šè¢«æ‰“åŒ…è¿›å»
          echo "node_modules/" > .vscodeignore
          echo "Dependencies installed and .vscodeignore created."

      # æ­¥éª¤ 9: é‡æ–°æ‰“åŒ…æˆæ–°çš„ VSIX æ–‡ä»¶ï¼ˆä½¿ç”¨åŒ…å«ç‰ˆæœ¬å·çš„æ–‡ä»¶åï¼‰
      - name: Repackage Patched VSIX
        if: steps.version_check.outputs.skip_build == 'false'
        id: repackage
        run: |
          PATCHED_VSIX_NAME="augment.vscode-augment-${{ env.VERSION }}-patched.vsix"
          echo "PATCHED_VSIX_NAME=${PATCHED_VSIX_NAME}" >> $GITHUB_ENV
          cd unpacked_ext/extension
          vsce package --out ../../${PATCHED_VSIX_NAME}
          echo "Patched VSIX created: ${PATCHED_VSIX_NAME}"
          ls -l ../../*.vsix

      # æ­¥éª¤ 10: åˆ›å»º GitHub Release å¹¶ä¸Šä¼ æ‰“åŒ…å¥½çš„ VSIX
      - name: Create GitHub Release
        if: steps.version_check.outputs.skip_build == 'false'
        uses: softprops/action-gh-release@v2
        with:
          # ä½¿ç”¨æ’ä»¶ç‰ˆæœ¬å·åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ Git æ ‡ç­¾
          tag_name: "v${{ env.VERSION }}-patched"
          name: "Patched Augment v${{ env.VERSION }}"
          body: |
            This is an automated build of the Augment extension, patched with the v2.5 anti-telemetry script.
            
            - Original Extension Version: **${{ env.VERSION }}**
            - Patch Script: v2.5-precise-interceptor.js
            
            Install the `.vsix` file below manually in VS Code.
          # å°†æ‰“åŒ…å¥½çš„æ–‡ä»¶ä½œä¸ºé™„ä»¶ä¸Šä¼  (ä½¿ç”¨åŠ¨æ€æ–‡ä»¶å)
          files: "${{ env.PATCHED_VSIX_NAME }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
